# .github/workflows/auto-document-pr.yml
name: Auto Document PR and Update README

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  document-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install -r scripts/requirements.txt

      - name: Get PR changes
        id: changes
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > changes.diff
          echo "diff_file=changes.diff" >> $GITHUB_OUTPUT

      - name: Generate Mermaid diagram with Copilot API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ¨ Generando diagrama Mermaid con Copilot API..."
          
          # Construir payload con Python para mejor manejo
          python3 << 'PYTHON_SCRIPT'
          import json
          import subprocess
          import sys
          
          # Leer diff
          with open('changes.diff', 'r', encoding='utf-8', errors='ignore') as f:
              diff_content = f.read()[:8000]
          
          if not diff_content.strip():
              print("âš ï¸ Diff vacÃ­o")
              with open('scripts/copilot_mermaid.md', 'w') as f:
                  f.write("""```mermaid
          graph TD
              A[No Changes Detected]
          ```""")
              sys.exit(0)
          
          prompt = f"""Analiza estos cambios y genera un diagrama Mermaid:

          ```diff
          {diff_content}
          ```

          Genera SOLO cÃ³digo Mermaid dentro de:
          ```mermaid
          [tu diagrama]
          ```
          
          Usa sequenceDiagram para flujos, classDiagram para estructuras, o graph TD para arquitectura."""
          
          payload = {
              "messages": [
                  {
                      "role": "system",
                      "content": "Eres experto en Mermaid. Respondes SOLO con cÃ³digo Mermaid vÃ¡lido."
                  },
                  {
                      "role": "user",
                      "content": prompt
                  }
              ],
              "model": "gpt-4o",
              "temperature": 0.3,
              "max_tokens": 1500
          }
          
          # Guardar payload
          with open('mermaid-payload.json', 'w') as f:
              json.dump(payload, f, indent=2)
          
          print("âœ… Payload creado")
          print(f"ğŸ“Š Diff size: {len(diff_content)} caracteres")
          PYTHON_SCRIPT
          
          # Usar el endpoint correcto de Copilot
          echo "ğŸ¤– Llamando a Copilot API..."
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o mermaid-response.json \
            -X POST "https://api.githubcopilot.com/chat/completions" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -H "Editor-Version: vscode/1.95.0" \
            -H "Editor-Plugin-Version: copilot-chat/0.22.0" \
            -H "User-Agent: GitHubCopilotChat/0.22.0" \
            -d @mermaid-payload.json)
          
          echo "ğŸ“¡ HTTP Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… API respondiÃ³ exitosamente"
            
            # Extraer contenido
            python3 << 'PYTHON_SCRIPT'
          import json
          import sys
          
          try:
              with open('mermaid-response.json', 'r') as f:
                  response = json.load(f)
              
              if 'choices' in response and len(response['choices']) > 0:
                  content = response['choices'][0]['message']['content']
                  
                  if content and content.strip() and content != 'null':
                      with open('scripts/copilot_mermaid.md', 'w') as f:
                          f.write(content)
                      print("âœ… Diagrama guardado")
                      print(f"ğŸ“„ Preview ({len(content)} caracteres):")
                      print(content[:300])
                  else:
                      print("âš ï¸ Contenido vacÃ­o, usando fallback Python")
                      raise Exception("Empty content")
              else:
                  print("âŒ Formato inesperado:", response)
                  raise Exception("Invalid format")
          except Exception as e:
              print(f"Error: {e}")
              print("ğŸ”„ Usando generador Python fallback...")
              sys.exit(1)
          PYTHON_SCRIPT
            
            PYTHON_EXIT=$?
            if [ $PYTHON_EXIT -ne 0 ]; then
              echo "âš ï¸ ExtracciÃ³n fallÃ³, usando fallback Python..."
              python3 scripts/generate_mermaid.py \
                --diff changes.diff \
                --output scripts/copilot_mermaid.md
            fi
          else
            echo "âŒ Error HTTP $HTTP_CODE"
            echo "ğŸ“„ Respuesta del API:"
            cat mermaid-response.json || echo "No se pudo leer respuesta"
            
            # Fallback a generador Python
            echo "ğŸ”„ Usando generador Python fallback..."
            python3 scripts/generate_mermaid.py \
              --diff changes.diff \
              --output scripts/copilot_mermaid.md
          fi
          
          # Verificar archivo final
          if [ -f scripts/copilot_mermaid.md ]; then
            FILESIZE=$(wc -c < scripts/copilot_mermaid.md)
            echo "âœ… Diagrama final generado ($FILESIZE bytes)"
          else
            echo "âŒ Error: archivo no generado"
            exit 1
          fi

      - name: Generate documentation with GitHub Copilot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/generate_pr_docs.py \
            --diff changes.diff \
            --context pr_context.json \
            --output pr_documentation.md \
            --template scripts/pr_template.md

      - name: Post documentation comment on PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          python3 scripts/post_pr_comment.py

      - name: Update README
        run: |
          python3 scripts/update_readme.py
          echo "ğŸ“‹ Archivos despuÃ©s de actualizar README:"
          ls -la *.md || true

      - name: Commit changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configurar git
          git config --local user.name 'github-actions[bot]'
          git config --local user.email 'github-actions[bot]@users.noreply.github.com'
          
          echo "ğŸ“Š Branch actual:"
          git branch --show-current
          
          echo "ğŸ“Š Estado de Git antes de add:"
          git status
          
          echo "ğŸ“¥ Agregando archivos modificados..."
          git add README.md README.MD readme.md Readme.md pr_documentation.md pr_history scripts/copilot_mermaid.md 2>/dev/null || true
          
          echo "ğŸ“Š Archivos en staging:"
          git diff --cached --name-only
          
          echo "ğŸ“Š Estado de Git despuÃ©s de add:"
          git status
          
          echo "ğŸ’¾ Verificando si hay cambios para commitear..."
          if git diff --cached --quiet; then
            echo "âš ï¸  No hay cambios para commitear"
            exit 0
          fi
          
          echo "âœ… Hay cambios, creando commit..."
          git commit -m "docs: auto-update README with PR changes [skip ci]"
          
          echo "ğŸš€ Haciendo push al branch del PR..."
          git push origin HEAD:${{ github.head_ref }}
          
          echo "âœ… Push completado exitosamente!"